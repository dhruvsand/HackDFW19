!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r(e.DataGraph=e.DataGraph||{})}(this,function(e){"use strict";function r(e,t,n,o){o=n(o,t(e));var i=e.getState().source;return"object"!==(void 0===i?"undefined":U(i))||Array.isArray(i)?o:r(i,t,n,o)}function t(e,t){return r(t,R,function(r,t){return e.parser.parseDataState(t.getState(),r)},{select:[],from:"",where:[],groupby:[],having:[],orderby:[],limit:"",offset:"",unresolved:{}})}function n(e){return"string"==typeof e?e.replace(/'/gi,"''"):e}function o(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:F;if("string"==typeof e||"object"===!(void 0===e?"undefined":U(e)))return e;switch(e.type){case"=":case"<>":case"<":case">":case"<=":case">=":return e.left+" "+e.type+" "+("string"==typeof e.right?"'"+e.right+"'":e.right);case"between":case"not between":return e.field+" "+e.type.toUpperCase()+" "+e.left+" AND "+e.right;case"is null":case"is not null":return e.field+" "+e.type.toUpperCase();case"ilike":case"like":case"not like":return e.left+" "+e.type.toUpperCase()+" '%"+e.right+"%'";case"coalesce":return"COALESCE("+e.values.map(function(e){return"'"+e+"'"}).join(", ")+")";case"in":case"not in":return Array.isArray(e.set)?e.expr+" "+e.type.toUpperCase()+" ("+e.set.map(function(e){return"number"==typeof e?e:"'"+n(e)+"'"}).join(", ")+")":"object"!==U(e.set)||"data"!==e.set.type&&"root"!==e.set.type?e:e.expr+" "+e.type.toUpperCase()+" ("+r.writeSQL(e.set)+")";case"not":return"NOT("+o(e.expr)+")";case"and":case"or":return"("+o(e.left)+" "+e.type.toUpperCase()+" "+o(e.right)+")";case"case":var t=null===e.else?"NULL":"'"+e.else+"'";return"CASE WHEN "+e.cond.map(function(e){return o(e[0])+" THEN "+e[1]}).join(" ")+(void 0!==e.else?" ELSE "+t:"")+" END";case"date_trunc":return"date_trunc("+e.unit+", "+e.field+")";case"extract":return"extract("+e.unit+" from "+e.field+")";case"root":return"("+r.writeSQL(e)+")";case"count":return e.distinct&&e.approx?"approx_count_distinct("+e.field+")":e.distinct?"count(distinct "+e.field+" )":"count("+e.field+")";case"stddev":case"stddev_pop":case"stddev_samp":case"var_pop":case"var_samp":return e.type+"("+e.x+")";case"corr":case"covar_pop":case"covar_samp":return e.type+"("+e.x+", "+e.y+")";case"min":case"max":case"sum":case"sample":return e.type+"("+e.field+")";case"average":return"avg("+e.field+")";default:return e}}function i(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{select:[],from:"",where:[],groupby:[],having:[],orderby:[],limit:"",offset:"",unresolved:{}};return e.transform.reduce(function(e,t){return r.parseTransform(e,t)},{select:t.select,from:"root"===e.type?"string"==typeof e.source?e.source:r.parseSource(e.source):t.from,where:t.where,groupby:t.groupby,having:t.having,orderby:t.orderby,limit:t.limit,offset:t.offset,unresolved:t.unresolved})}function a(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:F;return Array.isArray(r.groupby)?r.groupby.forEach(function(r){e=s(e,r,t)}):e=s(e,r.groupby,t),r.fields.forEach(function(t,n){var o=r.as[n];e.select.push(u(r.ops[n],t,o))}),e}function u(e,r,t){var n="";return(n+=null===e?r:G[e]?G[e]+"("+r+")":e+"("+r+")")+(t?" as "+t:"")}function s(e,r,t){return"string"==typeof r?(e.select.push(r),e.groupby.push(r)):"bin"===r.type?(e=t.parseTransform(e,r)).groupby.push(r.as):"project"===r.type&&(e.select.push(t.parseExpression(r.expr)+(r.as?" as "+r.as:"")),r.as&&e.groupby.push(r.as)),e}function c(e,r){var t=r.field,n=r.as,o=r.extent,i=r.maxbins;return e.select.push("cast((cast("+t+" as float) - "+o[0]+") * "+i/(o[1]-o[0])+" as int) as "+n),e.where.push("(("+t+" >= "+o[0]+" AND "+t+" <= "+o[1]+") OR ("+t+" IS NULL))"),e.having.push("("+n+" >= 0 AND "+n+" < "+i+" OR "+n+" IS NULL)"),e}function f(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:F;switch(r.type){case"filter":e.where.push("("+("object"===U(r.expr)?t.parseExpression(r.expr):r.expr)+")");default:return e}}function p(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:F;switch(r.type){case"crossfilter":"object"===U(e.unresolved)&&e.unresolved.hasOwnProperty(r.signal)&&Object.keys(r.filter).forEach(function(n){var o=r.filter[n];if(e.unresolved){var i=e.unresolved[r.signal].ignore;(Array.isArray(i)?-1===i.indexOf(n):n!==i)&&f(e,o,t)}});default:return e}}function l(e,r){return r.field.forEach(function(t,n){e.orderby.push(t+(Array.isArray(r.order)?" "+H[r.order[n]]:""))}),e}function d(e,r){return e.limit+=r.row,e.offset+=r.offset||e.offset,e}function y(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:F;return e.select.push(t.parseExpression(r.expr)+(r.as?" as "+r.as:"")),e}function g(e,r){switch(r.type){case"resolvefilter":"object"===U(e.unresolved)?e.unresolved[r.filter.signal]=r:e.unresolved=M({},r.filter.signal,r);default:return e}}function v(e,r){if("multiplicative"===r.method){var t=r.size,n=r.limit,o=Math.min(n/t,1);if(1>o){var i=Math.floor(k*o);e.where.push("MOD( MOD ("+e.from+".rowid, "+k+") * "+Q+" , "+k+") < "+i)}}return e}function h(e){switch(e){case"join.left":return"LEFT JOIN";case"join.right":return"RIGHT JOIN";case"join.inner":return"INNER JOIN";case"join":default:return"JOIN"}}function m(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:F;return e.reduce(function(e,t,n){if("string"==typeof t.table&&"scan"===t.type)return e.concat(t.table);if("join"===t.type||"join.inner"===t.type||"join.left"===t.type||"join.right"===t.type){var o=e.pop(),i=e.pop()+" "+h("string"==typeof t.type?t.type:"join")+" "+o,a="string"==typeof t.as?" as "+t.as:"";return e.concat(i+a)}if("data"===t.type||"root"===t.type){var u=r.writeSQL(t);return e.concat("("+u+")")}return e},[]).join()}function b(e,r,t){switch(r.type){case"aggregate":return a(e,r,t);case"bin":return c(e,r);case"sort":return l(e,r);case"limit":return d(e,r);case"filter":return f(e,r,t);case"project":return y(e,r,t);case"sample":return v(e,r);case"resolvefilter":return g(e,r);case"crossfilter":return p(e,r);default:return e}}function x(e,r){return j(r.parseDataState(e))}function j(e){return w(e.select)+E(e.from)+S(e.where)+A(e.groupby)+O(e.having)+N(e.orderby)+D(e.limit)+L(e.offset)}function w(e){return e.length?"SELECT "+e.join(", "):"SELECT *"}function E(e){return" FROM "+e}function S(e){return e.length?" WHERE "+e.join(" AND "):""}function A(e){return e.length?" GROUP BY "+e.join(", "):""}function O(e){return e.length?" HAVING "+e.join(" AND "):""}function N(e){return e.length?" ORDER BY "+e.join(", "):""}function D(e){return e.length?" LIMIT "+e:""}function L(e){return e.length?" OFFSET "+e:""}function C(){var e={},r={},t={parseExpression:function(e){return r[e.type]?r[e.type](e,t):o(e,t)},parseTransform:function(r,n){return e[n.type]?e[n.type](r,n,t):b(r,n,t)},parseDataState:function(e,r){return i(e,t,r)},parseSource:function(e){return m(e,t)},writeSQL:function(e){return x(e,t)},write:j,registerParser:function(t,n){"expression"===t.meta?r[t.type]=n:"transform"===t.meta&&(e[t.type]=n)}};return t}function I(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={type:r.type||"data",source:r.source,transform:r.transform||[],children:r.children||[]},o={getState:function(){return n},transform:function(e){return n.transform="function"==typeof e?e(n.transform):e,o},toSQL:function(){return e.parser.write(t(e,o))},values:function(){return e.connector.query(e.parser.write(t(e,o)))},data:function(r){var t=I(e,P({},r,{source:o}));return n.children.push(t),t}};return o}function T(e){return Array.isArray(e)?{fields:e.map(function(e){return e.field}),ops:e.map(function(e){return e.type}),as:e.map(function(e){return e.as})}:{fields:[e.field],ops:[e.type],as:[e.as||""]}}function _(e){return Array.isArray(e)?e.map(function(e){return"object"===(void 0===e?"undefined":U(e))?{type:"project",expr:e.expr,as:e.as}:e}):"object"===(void 0===e?"undefined":U(e))?{type:"project",expr:e.expr,as:e.as}:e}var U="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},M=function(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e},P=Object.assign||function(e){for(var r=1;arguments.length>r;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},R=function(e){return e},G={average:"AVG",count:"COUNT",min:"MIN",max:"MAX",sum:"SUM"},H={ascending:"ASC",descending:"DESC"},Q=2654435761,k=4294967296,F=C(),J=process.env.NODE_ENV,V=function(e,r,t,n,o,i,a,u){if("production"!==J&&void 0===r)throw Error("invariant requires an error message argument");if(!e){var s;if(void 0===r)s=Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var c=[t,n,o,i,a,u],f=0;(s=Error(r.replace(/%s/g,function(){return c[f++]}))).name="Invariant Violation"}throw s.framesToPop=1,s}},q=Object.freeze({alias:function(e,r){return{expr:r,as:e}},avg:function(e,r){return{type:"average",field:r,as:e}},min:function(e,r){return{type:"min",field:r,as:e}},max:function(e,r){return{type:"max",field:r,as:e}},sum:function(e,r){return{type:"sum",field:r,as:e}},count:function(e,r,t){return{type:"count",distinct:e,approx:!1,field:t,as:r}},approxCount:function(e,r,t){return{type:"count",distinct:e,approx:!0,field:t,as:r}},countStar:function(e){return{type:"count",distinct:!1,approx:!1,field:"*",as:e}},extract:function(e,r){return{type:"extract",unit:e,field:r}},dateTrunc:function(e,r){return{type:"date_trunc",unit:e,field:r}},inExpr:function(e,r){return{type:"in",expr:e,set:r}},not:function(e){return{type:"not",expr:e}},caseExpr:function(e,r){return{type:"case",cond:e,else:r}},between:function(e,r){return{type:"between",field:e,left:r[0],right:r[1]}}}),z=Object.freeze({project:function(e){return{type:"project",expr:"string"==typeof e?e:e.expr,as:"string"==typeof e?null:e.as}},aggregate:function(e,r){var t=T(r),n=_(e);return{type:"aggregate",fields:t.fields,ops:t.ops,as:t.as,groupby:n}},filter:function(e){return{type:"filter",id:arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",expr:e}},filterRange:function(e,r){return{type:"filter",id:arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",expr:{type:"between",field:e,left:r[0],right:r[1]}}},filterIn:function(e,r){return{type:"filter",id:arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",expr:{type:"in",expr:e,set:r}}},bin:function(e,r,t,n){return{type:"bin",field:r,extent:t,maxbins:n,as:e}},limit:function(e,r){return{type:"limit",row:e,offset:r}},sort:function(e,r){return{type:"sort",field:"string"==typeof e?[e]:e,order:"string"==typeof r?[r]:r}},top:function(e,r,t){return[{type:"sort",field:[e],order:["descending"]},{type:"limit",row:r,offset:t}]},bottom:function(e,r,t){return[{type:"sort",field:[e],order:["ascending"]},{type:"limit",row:r,offset:t}]}});e.createDataGraph=function(e){V("function"==typeof e.query,"invalid connector");var r={connector:e,parser:C()},t=[];return{registerParser:function(e,t){r.parser.registerParser(e,t)},children:function(){return t},data:function(e){var n=I(r,"string"==typeof e||Array.isArray(e)?{source:e,type:"root"}:P({},e,{type:"root"}));return t.push(n),n}}},e.expr=q,e.rel=z,e.createParser=C,Object.defineProperty(e,"__esModule",{value:!0})});
